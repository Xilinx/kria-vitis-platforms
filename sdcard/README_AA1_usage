/******************************************************************************
* Copyright (C) 2010 - 2020 Xilinx, Inc. All rights reserved.
* SPDX-License-Identifier: Apache-2.0
******************************************************************************/

1. File structure:
    The application is installed as:
        Binary File: => /opt/xilinx/bin
                                        somapp                      main app

        Script File: => /opt/xilinx/bin/
                                        setupmipi.sh         find mipi meida number, to be used by somapp.
                                        01.mipi-rtsp.sh      call somapp to run facedetction and send out rtsp stream.
                                        02.mipi-dp.sh        call somapp to run facedetction and display on DP display.
                                        03.file-file.sh      call somapp to run facedetction and display on input h264/5
                                                                  file and generate output h264/5 with detection boxes.
        configuration File: => /opt/xilinx/share/ivas
                                        kernel_boundingbox_facedetect.json
                                        kernel_densebox_640_360.json
                                        kernel_xpp_pipeline.json

    Jupyter notebook file:  => /usr/share/notebooks/somapp
                                        AA1.ipynb
                                                             Jupyter notebook file for MIPI->RTSP demo.

2. How to run application:
    0) Prerequisites:
       a) Monitor:
          Before booting the board, please connect the monitor to the board via either DP or HDMI port.
       b) RTSP client:
          You need another PC having network access to the board as the RTSP client machine.
          On the client machine, to receive and play the RTSP stream, you should install ffplay which is part of package FFmpeg.
            For Linux, you can install FFmpeg with the package manager of your distribution.
            For Windows, you can find install instructions on https://ffmpeg.org/download.html

    1) MIPI RTSP server:
       a) Invoking "01.mipi-rtsp.sh" will start rtsp server for mipi captured images
       b) Script accepts ${width} ${height} as the 1st and 2nd parameter, the default is 1920 x 1080
       c) Run "ffplay rtsp://boardip:5000/test" on the client PC to receive the rtsp stream.
       d) Checking:
          You should be able to see the images the camera is capturing on the ffplay window, and when there's face captured 
          by camera, there should be blue box drawn around the face, and the box should follow the movemnt of the face.

    2) MIPI DP display
       a) Make sure the monitor is connected as 0)-a).
       b) Invoking "02.mipi-dp.sh" will play the captured video with detection results on monitor.
       c) Script accepts ${width} ${height} as the 1st and 2nd parameter, the default is 1920 x 1080
       d) Checking:
          You should be able to see the images the camera is capturing on the monitor connected to the board,  and when there's
          face captured by camera, there should be blue box drawn around the face, and the box should follow the movemnt of the face.

    3) File to File
       a) Invoking "03.file-to-file.sh"
       b) Read in the sample video file from "/usr/share/somapp/movies/walking-people.nv12.30fps.1080p.h264",
          perform detection and generate video with detection bbox, save as ./out.h264
       c) Checking:
          Play the input video file "/usr/share/somapp/movies/walking-people.nv12.30fps.1080p.h264" and generated video file 
          "./out.h264" with any media player you prefer, e.g. VLC, ffplay.
          You should be able to see in the output video file, there are blue boxes around the faces of walking peoples, and the boxes
          should follow the movemnt of the faces, while there's no such boxes with the input video file.

3. More combinations based on somapp invocation:
   Above 3 scripts works as examples to show capability of the somapp by giving proper parameters.
   More combinations could be made based on the options provided by somapp.
   You can get detailed application options as following by invoking ./somapp --help.

    Usage:
      somapp [OPTION?] - Application for facedetion detction on SoM board of Xilinx.
    
    Help Options:
      -?, --help                        Show help options
      --help-all                        Show all help options
      --help-gst                        Show GStreamer Options
    
    Application Options:
      -m, --mipi=media_ID               mipi media id, e.g. 1 for /dev/media1
      -u, --usb=video_ID                usb camera video device id, e.g. 2 for /dev/video2
      -f, --file=file path              location of h26x file as input
      -i, --infile-type=h264            input file type: [h264 | h265]
      -w, --w=1920                      resolution w of the input
      -h, --h=1080                      resolution h of the input
      -r, --framerate=30                framerate of the input
      -t, --target=dp                   [dp|rtsp|file]
      -o, --outmedia-type=h264          output file type: [h264 | h265]
      -p, --port=5000                   Port to listen on (default: 5000)
      -n, --nodet                       no AI inference

   Example of supported combinations and limitations:
   1) input MIPI:
      output: RTSP
        somapp  --mipi 0 -w 1920 -h 1080 --target rtsp >/dev/null 2>&1
      output: DP
        somapp  --mipi 0 -w 1920 -h 1080 --target dp >/dev/null 2>&1
      output: file
        somapp  --mipi 0 -w 1920 -h 1080 --target file >/dev/null 2>&1

   2) input file:
      output: DP [! detection not effective !]
        somapp  --file ./test.h264 -i h264 -w 1920 -h 1080 -r 30 --target dp >/dev/null 2>&1
      output: RTSP [! currently not ok, will update later !]
        somapp  --file ./test.h264 -i h264 -w 1920 -h 1080 -r 30 --target rtsp >/dev/null 2>&1
      output: file
        somapp  --file ./test.h264 -i h264 -w 1920 -h 1080 -r 30 --target file >/dev/null 2>&1

   3) input USB:
      Please make sure the width/height/framerate are supported by USB camera.
      output: DP
        somapp  --usb 1 -w 1920 -h 1080 -r 30 --target dp >/dev/null 2>&1
      output: RTSP [! currently not ok, will update later !]
        somapp  --usb 1 -w 1920 -h 1080 -r 30 --target rtsp >/dev/null 2>&1
      output: file
        somapp  --usb 1 -w 1920 -h 1080 -r 30 --target file >/dev/null 2>&1
